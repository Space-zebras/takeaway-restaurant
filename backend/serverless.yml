# org: ${env:ORG}
service: backend
useDotenv: true

plugins:
  - serverless-offline
# - serverless-esbuild
  # - serverless-dotenv-plugin

provider:
  name: aws
  runtime: nodejs20.x
  region: eu-north-1
  #profile: ${env:PROFILE}
  role: ${env:IAM_ROLE}

  httpApi:
    cors: true
      # allowOrigins:
      #   - "*"
      # allowHeaders:
      #   - "*"
      # allowMethods:
      #   - GET
      #   - POST
      # maxAge: 600

  environment:
    MENU_TABLE: ${env:MENU_TABLE}
    STOCK_TABLE: ${env:STOCK_TABLE}
    ORDERS_TABLE: ${env:ORDERS_TABLE}
    ADMIN_TABLE: ${env:ADMIN_TABLE}
    JWT_SECRET: ${env:JWT_SECRET}

build:
  esbuild:
    bundle: true  
    minify: true

package:
  individually: true

functions:
  getMenu:
    handler: menu/get-menu.handler
    events:
      - httpApi:
          path: /menu
          method: get

  # updateMenuItem:
  #   handler: menu/update-menu-item.mts
  #   events:
  #     - httpApi:
  #         path: /menu/{id}
  #         method: put

  createOrder:
    handler: orders/create-order.handler
    events:
      - httpApi:
          path: /orders
          method: post


  getOrders:
    handler: orders/get-orders.handler
    events:
      - httpApi:
          path: /orders
          method: get

  getOrder:
    handler: orders/get-order.handler
    events:
      - httpApi:
          path: /orders/{orderId}
          method: get

  adminLogin:
    handler: admin/login.handler
    events:
      - httpApi:
          path: /admin/login
          method: post

  # updateOrder:
  #   handler: orders/update-order.mts
  #   events:
  #     - httpApi:
  #         path: /orders/{id}
  #         method: put

resources:
  Resources:
    OrdersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: orders
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE

    AdminTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${env:ADMIN_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH

        # GlobalSecondaryIndexes:
          # - IndexName: entityIndex
          #   KeySchema:
          #     - AttributeName: entityType
          #       KeyType: HASH
          #     - AttributeName: checkIn
          #       KeyType: RANGE
          #   Projection:
          #     ProjectionType: ALL
